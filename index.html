(function() {
  'use strict';
  
  // CONFIGURACIÃ“N CLAVE
  const GEMINI_API_KEY = "AIzaSyDDZsV69Pp3mIHyba4liiEMKTHZa1MIMpI";
  
  const languages = {
    es: { name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', label: 'Concepto BGM', call: 'Video Chat' },
    en: { name: 'English', flag: 'ğŸ‡¬ğŸ‡§', label: 'BGM Concept', call: 'Video Chat' },
    de: { name: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª', label: 'BGM Konzept', call: 'Video Chat' },
    it: { name: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹', label: 'Concetto BMG', call: 'Video Chat' },
    fr: { name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', label: 'Concept BGM', call: 'Video Chat' },
    ja: { name: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ', label: 'BGMã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ', call: 'ãƒ“ãƒ‡ã‚ªãƒãƒ£ãƒƒãƒˆ' },
    ar: { name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦', label: 'Ù…ÙÙ‡ÙˆÙ… BGM', call: 'ÙÙŠØ¯ÙŠÙˆ ØªØ´Ø§Øª' },
    zh: { name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³', label: 'BGM æ¦‚å¿µ', call: 'è§†é¢‘èŠå¤©' }
  };

  const systemPrompts = {
    es: `Eres la interfaz de IA estratÃ©gica de BridgeMindGames (BGM). Tu misiÃ³n es presentar el proyecto a FINANCISTAS e INVERSORES 24/7.
    - Concepto: EnseÃ±anza de 8 idiomas mediante Bridge + IA.
    - VisiÃ³n: Escalabilidad global y disrupciÃ³n EdTech.
    - REGLA: No des datos financieros. Di: "Los datos especÃ­ficos se tratan con el fundador, Alejandro, por video chat".
    - Contacto: Alejandro +34 634 268 663.`,
    en: `You are the strategic AI interface for BridgeMindGames (BGM). Present the project to INVESTORS 24/7.
    - Concept: Teaching 8 languages through Bridge + AI.
    - Vision: Global scalability and EdTech disruption.
    - RULE: No financial data. Say: "Specific data is handled by the founder, Alejandro, via video chat".
    - Contact: Alejandro +34 634 268 663.`
    // (La IA adaptarÃ¡ el resto de idiomas automÃ¡ticamente basÃ¡ndose en estos pilares)
  };

  let selectedLanguage = null;
  let isInitialized = false;

  function initBMGBot() {
    if (isInitialized) return;

    const style = document.createElement('style');
    style.textContent = `
      #bmg-button {
        position: fixed; bottom: 24px; right: 24px;
        background: #000; color: #fff; border: 2px solid #764ba2;
        border-radius: 50px; padding: 12px 24px; font-weight: bold;
        cursor: pointer; z-index: 10000; display: flex; align-items: center; gap: 10px;
        box-shadow: 0 4px 15px rgba(118,75,162,0.4); font-family: sans-serif;
      }
      .bmg-dot { width: 10px; height: 10px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 5px #00ff00; }
      
      #bmg-chat {
        position: fixed; bottom: 85px; right: 24px;
        width: 360px; height: 500px; background: #fff;
        border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: none; flex-direction: column; z-index: 10000;
        border: 1px solid #ddd; font-family: sans-serif; overflow: hidden;
      }
      #bmg-header { background: #1a1a1a; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #764ba2; }
      #bmg-messages { flex: 1; overflow-y: auto; padding: 15px; background: #fdfdfd; }
      .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.4; }
      .bot { background: #f0f0f0; color: #333; align-self: flex-start; }
      .user { background: #764ba2; color: white; align-self: flex-end; margin-left: 20%; }
      
      .btn-quick { background: white; border: 1px solid #764ba2; color: #764ba2; padding: 5px 10px; border-radius: 15px; cursor: pointer; margin: 5px 5px 0 0; font-size: 12px; }
      .btn-quick:hover { background: #764ba2; color: white; }
      
      #bmg-input-box { padding: 10px; display: flex; border-top: 1px solid #eee; }
      #bmg-input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 5px; outline: none; }
    `;
    document.head.appendChild(style);

    const el = document.createElement('div');
    el.innerHTML = `
      <button id="bmg-button"><div class="bmg-dot"></div> BMG EXECUTIVE 24/7</button>
      <div id="bmg-chat">
        <div id="bmg-header">
          <div><strong>BridgeMindGames</strong><br><small style="color:#00ff00">â— Online para inversores</small></div>
          <span id="bmg-close" style="cursor:pointer;font-size:20px">Ã—</span>
        </div>
        <div id="bmg-messages"></div>
        <div id="bmg-input-box">
          <input type="text" id="bmg-input" placeholder="Escriba su consulta...">
          <button id="bmg-send" style="background:#764ba2;color:white;border:none;padding:8px 15px;margin-left:5px;border-radius:5px;cursor:pointer">â¤</button>
        </div>
      </div>
    `;
    document.body.appendChild(el);

    const chat = document.getElementById('bmg-chat');
    const msgs = document.getElementById('bmg-messages');
    const input = document.getElementById('bmg-input');

    function showLangs() {
      msgs.innerHTML = '<p style="text-align:center;font-size:12px">Select Language / Seleccione Idioma</p><div id="bmg-langs" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>';
      for (let code in languages) {
        const b = document.createElement('button');
        b.className = 'btn-quick';
        b.innerHTML = `${languages[code].flag} ${languages[code].name}`;
        b.onclick = () => {
          selectedLanguage = code;
          msgs.innerHTML = `<div class="msg bot">Sistema BGM activo en ${languages[code].name}. Â¿QuÃ© desea saber sobre nuestra visiÃ³n de negocio?</div>`;
          const actions = document.createElement('div');
          actions.innerHTML = `
            <button class="btn-quick" onclick="window.bmgS('${languages[code].label}')">${languages[code].label}</button>
            <button class="btn-quick" onclick="window.bmgS('${languages[code].call}')">${languages[code].call}</button>
          `;
          msgs.appendChild(actions);
        };
        document.getElementById('bmg-langs').appendChild(b);
      }
    }

    window.bmgS = (t) => { input.value = t; send(); };

    async function send() {
      const txt = input.value; if (!txt) return;
      const u = document.createElement('div'); u.className = 'msg user'; u.textContent = txt;
      msgs.appendChild(u); input.value = ''; msgs.scrollTop = msgs.scrollHeight;

      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{role:'user', parts:[{text:txt}]}], systemInstruction: {parts:[{text:systemPrompts[selectedLanguage]||systemPrompts.es}]}})
      });
      const d = await r.json();
      const b = document.createElement('div'); b.className = 'msg bot';
      b.textContent = d.candidates[0].content.parts[0].text;
      msgs.appendChild(b); msgs.scrollTop = msgs.scrollHeight;
    }

    document.getElementById('bmg-send').onclick = send;
    document.getElementById('bmg-button').onclick = () => { chat.style.display='flex'; showLangs(); };
    document.getElementById('bmg-close').onclick = () => { chat.style.display='none'; };
  }
  initBMGBot();
})();
